{% extends "layout.j2" %}
{% block body %}

<div class="ui form">
{% for param in data.extra_vars %}
  <div class="_inline field">

  {# LABEL #}
  {% if param.boolean is undefined %}
    <label>{{ param.description }} <i>({{ param.name }})</i></label>
  {% endif %}

{% if param.search is defined %}

    {# SEARCH #}
    <div  id="extra_vars-{{ param.name }}"
          class="ui {{ param.attributes|get('multiple') }} search api selection dropdown">
      <input  type="hidden" name="{{ param.name }}">
      <i class="dropdown icon"></i>
      <input type="text" class="search">
      <div class="default text">Select ...</div>
    </div>

{% elif param.choices is defined %}

    {# CHOICES #}
    <div class="ui {{ param.attributes|get('multiple') }} multiple search selection dropdown">
      <input  type="hidden"
              value="{{ param.default }}"
              name="{{ param.name }}">
      <i class="dropdown icon"></i>
      <div class="default text">Select {{ param.name }}</div>
      <div class="menu">
{% for choice in param.choices %}
        <div class="item" data-value="{{ choice }}">{{ choice }}</div>
{% endfor %}
      </div>
    </div>

{% elif param.boolean is defined %}

    {# BOOLEAN #}
    <div class="ui toggle checkbox">
      <input  type="checkbox"
{% if param.boolean %}
              checked="checked"
{% endif %}
              name="{{ param.name }}">
      <label><b>{{ param.description }} <i>({{ param.name }})</i></b></label>
    </div>

{% else %}

    {# INPUT #}
    <input  type="text"
            name="{{ param.name }}"
            value="{{ param.default|default('') }}"
            placeholder="{{ param.description }}">

{% endif %}

  </div>
{% endfor %}

  <div class="ui primary submit button">Launch</div>
  <div class="ui error message"></div>
</div>
{% endblock %}

{% block script %}
$('.ui.dropdown.choices').dropdown()

// util function to extract
function sui_list_to_selected_options(values) {
  let options = []
  if (values.length > 0) {
    options = values.split(',').map(x => new Object({'name': x, 'value': x, 'selected': true}));
  }
  return options
}

{% for param in data.extra_vars %}{% if param.search is defined %}

$('#extra_vars-{{ param.name }}').dropdown({
  apiSettings: {
    url: '{{ param.search }}?{{ param.search_params }}',
    cache: false
  },
  clearable: true,
  filterRemoteData: true,
  values: sui_list_to_selected_options('{{ param.default }}'),
/*
  onShow : function() {
  	$(this).children('.menu').children('.item').each(function(a, b){
    	var value = $(this).attr('data-value');
      var text = $(this).attr('data-text');
      var name = $(this).text();
      console.log(name, value, text)
      if(name.indexOf('user') >= 0){
      	$(this).prepend("<i class='user icon'></i>");
      }else if(name.indexOf('group') >= 0){
      	$(this).prepend("<i class='users icon'></i>");
      }
    });
  }
*/  
});

{% endif %}{% endfor %}

$('.ui.form').form({
  fields: {
{% for param in data.extra_vars %}
  {% if 'required' in param.attributes|default([]) %}
    {{ param.name }} : 'empty',
  {% elif param.check is defined %}
    {{ param.name }} : '{{ param.check }}',
  {% endif %}
{% endfor %}
  }
});

console.log('ok')
{% endblock %}
